document.addEventListener("DOMContentLoaded",(async()=>{const t=document.getElementById("inflow-charts"),e=document.getElementById("expense-charts"),n=document.getElementById("sundry-charts"),a=document.getElementById("monthSelect"),o=document.getElementById("periodSelect"),r=document.querySelector("#expense-table tbody"),c=document.getElementById("fd-table-body"),s=document.getElementById("fd-total"),i=window.ENV.last_Year_Cash_In_Hand,l="https://raw.githubusercontent.com/alacrityhsgsociety-arch/alacrityhsgsociety-arch.github.io/refs/heads/main/data",d=`${l}/index.json?v=${Date.now()}`,u=["January","February","March","April","May","June","July","August","September","October","November","December"],m=["#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f","#edc948","#b07aa1","#ff9da7","#9c755f","#bab0ac"],h={};u.forEach(((t,e)=>{const n=document.createElement("option");n.value=e,n.textContent=t,e===(new Date).getMonth()&&(n.selected=!0),a.appendChild(n)}));let g=[];try{const t=await fetch(d);if(!t.ok)throw new Error(`HTTP ${t.status}`);g=await t.json()}catch(e){return console.error("Failed to load index.json:",e),void(t&&(t.innerHTML='<p class="text-danger">Failed to load data.</p>'))}const f=t=>null==t||""===t?0:"string"==typeof t?((t=t.replace(/[₹,\s]/g,"")).startsWith("(")&&t.endsWith(")")&&(t="-"+t.slice(1,-1)),parseFloat(t)||0):"number"==typeof t?t:0,p={id:"showTotals",afterDatasetsDraw(t){const{ctx:e,scales:{x:n,y:a}}=t;e.save(),t.data.labels.forEach(((o,r)=>{let c=0;if(t.data.datasets.forEach((t=>c+=t.data[r]||0)),c>0){const o="function"==typeof n.getPixelForValue?n.getPixelForValue(r):(r+.5)*(t.width/t.data.labels.length),s="function"==typeof a.getPixelForValue?a.getPixelForValue(c):t.height-c/(a.max||1)*t.height;e.fillStyle="#000",e.font="bold 10px sans-serif",e.textAlign="center",e.fillText(`₹${c.toLocaleString("en-IN",{maximumFractionDigits:0})}`,o,s-5)}})),e.restore()}};async function y(){try{const t=await fetch(`${l}/fixed_deposit.json?v=${Date.now()}`);if(!t.ok)return void console.warn("fixed_deposit.json not found at base path, status:",t.status);!function(t){if(!c)return;if(c.innerHTML="",!Array.isArray(t)||0===t.length){const t=document.createElement("tr");return t.innerHTML='<td colspan="3" class="text-center text-muted">No FDs found</td>',c.appendChild(t),void(s&&(s.textContent=""))}t.sort(((t,e)=>{const n=(t.Category||t.category||"").localeCompare(e.Category||e.category||"");return 0!==n?n:(t.Account||t.account||"").localeCompare(e.Account||e.account||"")}));let e=0;t.forEach((t=>{const n=f(t.Amount||t.amount);e+=n;const a=document.createElement("tr");a.innerHTML=`\n        <td>${t.Category||t.category||""}</td>\n        <td>${t.Account||t.account||""}</td>\n        <td class="text-end">₹ ${n.toLocaleString("en-IN",{minimumFractionDigits:2})}</td>\n      `,c.appendChild(a)}));const n=document.createElement("tr");n.classList.add("fw-bold","table-light"),c.appendChild(n),s&&(s.textContent=`₹ ${e.toLocaleString("en-IN",{minimumFractionDigits:2})}`)}(await t.json())}catch(t){console.error("Failed to load fd.json:",t)}}async function w(a){t&&(t.innerHTML=""),e&&(e.innerHTML=""),n&&(n.innerHTML=""),r&&(r.innerHTML=""),c&&(c.innerHTML=""),s&&(s.textContent="");let o=[],i=[];for(const n of g){const r=`${l}/${n}?v=${Date.now()}`;let c=[];try{const t=await fetch(r);if(!t.ok)throw new Error(`HTTP ${t.status}`);c=await t.json(),h[n]=c}catch(t){console.error(`Failed to load ${r}:`,t);continue}if(!c||!c.length)continue;const s=n.replace(".json","").replace(/_/g," "),d=Object.keys(c[0]||{}),g=d.find((t=>t.toLowerCase().includes("category"))),y=d.find((t=>t.toLowerCase().includes("sub category"))),w=d.find((t=>t.toLowerCase().includes("amount")));if(!g||!w)continue;const b={};c.forEach((t=>{const e=t.Date||t.date;if(!e)return;const r=new Date(e);if(isNaN(r))return;if(r.getMonth()!==a)return;const c=t[g]||"Other",s=y&&t[y]||"Other",l=f(t[w]);b[c]||(b[c]={}),b[c][s]=(b[c][s]||0)+l,"sundry"===(t.Category||t.category||"").toLowerCase()&&o.push(t),n.toLowerCase().includes("expense")&&i.push(t)}));for(const t in b){0===Object.values(b[t]).reduce(((t,e)=>t+e),0)&&delete b[t]}const C=Object.keys(b);if(!C.length)continue;const x=new Set;C.forEach((t=>Object.keys(b[t]).forEach((t=>x.add(t)))));const L=Array.from(x).map(((t,e)=>({label:t,data:C.map((e=>b[e][t]||0)),backgroundColor:m[e%m.length]}))),$=document.createElement("div");$.className="mb-4";const E=document.createElement("canvas");$.appendChild(E);let D=t;n.toLowerCase().includes("expense")?D=e:n.toLowerCase().includes("inflow")&&(D=t),D&&D.appendChild($);try{new Chart(E,{type:"bar",data:{labels:C,datasets:L},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:`${s} (${u[a]})`},tooltip:{callbacks:{label:function(t){const e=t.chart.data.labels[t.dataIndex],n=t.dataset.label,a=t.raw;return 0===a?null:`${e} → ${n}: ₹ ${a.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}},scales:{x:{stacked:!0,title:{display:!0,text:"Category"}},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:"Amount"},ticks:{callback:t=>`₹ ${t.toLocaleString("en-IN")}`}}}},plugins:[p]})}catch(t){console.warn("Chart render error:",t)}}!function(t,e){if(!t||!t.length)return;const a={};t.forEach((t=>{const e=t["Sub Category"]||t["sub category"]||"Other",n=f(t.Amount||t.amount);a[e]=(a[e]||0)+n}));const o=Object.keys(a),r=Object.values(a),c=document.createElement("div");c.className="mb-4";const s=document.createElement("canvas");c.appendChild(s),n&&n.appendChild(c);try{new Chart(s,{type:"pie",data:{labels:o,datasets:[{data:r,backgroundColor:o.map(((t,e)=>m[e%m.length]))}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:`Sundry (${u[e]})`},tooltip:{callbacks:{label:t=>`${t.label}: ₹ ${t.raw.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}}})}catch(t){console.warn("Sundry pie error:",t)}}(o,a),function(t){if(!r)return;if(!t||!t.length)return void(r.innerHTML='<tr><td colspan="6" class="text-center text-muted">No expense rows</td></tr>');r.innerHTML="",t.sort(((t,e)=>new Date(t.Date||t.date)-new Date(e.Date||e.date)));let e=0,n=0;if(t.forEach((t=>{const a=f(t.Amount||t.amount),o=(t.Category||t.category||"").trim().toLowerCase(),c=(t.Checked||t.checked||"").trim().toLowerCase();if(0===a)return;n++,"withdrawal self"!==o&&"withdrawl self"!==o&&"yes"===c&&(e+=a);const s=document.createElement("tr");s.classList.add("yes"===c?"table-success":"table-warning"),s.innerHTML=`\n        <td>${t.Date||t.date||""}</td>\n        <td>${t.Category||t.category||""}</td>\n        <td>${t["Sub Category"]||t["sub category"]||""}</td>\n        <td>${t["Payment To"]||t["payment to"]||""}</td>\n        <td>${t.Mode||t.mode||""}</td>\n        <td class="text-end">₹ ${a.toLocaleString("en-IN",{minimumFractionDigits:2})}</td>\n      `,r.appendChild(s)})),n>0){const t=document.createElement("tr");t.classList.add("fw-bold","table-light"),t.innerHTML=`\n        <td colspan="5" class="text-end">Total (Excl. Withdrawal Self)</td>\n        <td class="text-end">₹ ${e.toLocaleString("en-IN",{minimumFractionDigits:2})}</td>\n      `,r.appendChild(t)}}(i),b("inflow"),b("expense"),await y()}function b(t="expense"){const e=document.getElementById(`${t}-month-body`),n=document.getElementById(`${t}-month-header`),a=document.getElementById(`${t}-month-chart`);if(!e||!n)return;e.innerHTML="",n.innerHTML="<th>Category</th>",a&&(a.innerHTML="");const o={},r=Array(12).fill(0);for(const e of g){if(!e.toLowerCase().includes(`${t}`))continue;(h[e]||[]).forEach((e=>{const n=e.Date||e.date,a=(e.Category||e.category||"Other").trim(),c=f(e.Amount||e.amount),s=(e.Checked||e.checked||"").trim().toLowerCase();if(!n||0===c)return;if("expense"===t&&("withdrawal self"===a.toLowerCase()||"withdrawl self"===a.toLowerCase()||"yes"!==s))return;const i=new Date(n);if(isNaN(i))return;const l=i.getMonth();o[a]||(o[a]=Array(12).fill(0)),o[a][l]+=c,r[l]+=c}))}u.forEach((t=>{const e=document.createElement("th");e.textContent=t,n.appendChild(e)}));for(const t of Object.keys(o)){const n=document.createElement("tr");n.innerHTML=`<td>${t}</td>`+o[t].map((t=>0===t?"<td></td>":`<td>₹ ${t.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`)).join(""),e.appendChild(n)}const c=e.parentElement.querySelector("tfoot tr");if(c&&(c.innerHTML="<th>Grand Total</th>"+r.map((t=>0===t?"<th></th>":`<th>₹ ${t.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</th>`)).join("")),a){const e=document.createElement("div");e.className="mb-4";const n=document.createElement("canvas");e.appendChild(n),a.appendChild(e);try{new Chart(n,{type:"bar",data:{labels:u,datasets:[{label:`Total ${t} (₹)`,data:r,backgroundColor:"#4e79a7"}]},options:{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:`${t.charAt(0).toUpperCase()+t.slice(1)}: Monthly Totals`},tooltip:{callbacks:{label:t=>`₹${t.raw.toLocaleString("en-IN",{minimumFractionDigits:2})}`}},datalabels:{anchor:"end",align:"end",color:"#000",font:{weight:"normal",size:10},formatter:t=>0===t?"":`₹${t.toLocaleString("en-IN")}`}},scales:{x:{title:{display:!0,text:"Months"}},y:{beginAtZero:!0,title:{display:!0,text:"Amount (₹)"},ticks:{callback:t=>`₹${t.toLocaleString("en-IN")}`}}}},plugins:[ChartDataLabels]})}catch(e){console.warn(`{${t}} month chart error:`,e)}}}async function C(t="expenses"){for(const e of g){if(!e.toLowerCase().includes(t))continue;const n=`${l}/${e}?v=${Date.now()}`;let a=[];try{const t=await fetch(n);if(!t.ok)throw new Error(`HTTP ${t.status}`);return a=await t.json(),a}catch(t){console.error(`Failed to load ${n}:`,t);continue}}return[]}await async function(){const t=function(t,e){const n=t=>(t||"").toString().trim().toLowerCase(),a=t=>t&&parseFloat(t.toString().replace(/[₹,]/g,"").trim())||0;let o=0,r=0,c=0;for(const e of t){const t=n(e.Category||e.category),c=n(e.Mode||e.mode),s=a(e.Amount||e.amount);"withdrawl self"===t||"withdrawal self"===t?o+=s:"cash"===c&&(r+=s)}for(const t of e){const e=n(t.Mode||t.mode),o=a(t.Amount||t.amount);"cash"===e&&(c+=o)}return console.log("Total Withdrawals:",o),console.log("Total Cash Expenses:",r),console.log("Total Cash Inflows:",c),o+c-r}(await C("expenses"),await C("inflow"))+i;document.getElementById("result").textContent=`₹${t.toLocaleString("en-IN",{minimumFractionDigits:2})}`}();const x=(new Date).getMonth();await w(x),a&&a.addEventListener("change",(t=>w(parseInt(t.target.value)))),o&&o.addEventListener("change",(()=>w(parseInt(a.value))))}));